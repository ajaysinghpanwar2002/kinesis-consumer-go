services:
  localstack:
    image: localstack/localstack:3
    environment:
      - SERVICES=kinesis
      - AWS_DEFAULT_REGION=us-east-1
      - DEBUG=0
      - LOCALSTACK_HOST=localstack
      - HOSTNAME_EXTERNAL=localstack
      - KINESIS_PROVIDER=kinesis-mock
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"

  consumer:
    build:
      context: .
      dockerfile: Dockerfile.benchmark
      target: consumer
    environment:
      - AWS_ENDPOINT=http://localstack:4566
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_EC2_METADATA_DISABLED=true
      - STREAM_NAME=bench-stream
      - REDIS_ADDR=redis:6379
      - SHARD_CONCURRENCY=4
      - CHECKPOINT_EVERY=1000
      - BATCH_SIZE=1000
    depends_on:
      - localstack
      - redis
    ports:
      - "6060:6060"

  producer:
    build:
      context: .
      dockerfile: Dockerfile.benchmark
      target: producer
    environment:
      - AWS_ENDPOINT=http://localstack:4566
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_EC2_METADATA_DISABLED=true
      - STREAM_NAME=bench-stream
      - SHARD_COUNT=4
      - BATCH_SIZE=500
      - WORKERS=8
      - PAYLOAD_BYTES=1024
    depends_on:
      - localstack

volumes:
  localstack-data:
